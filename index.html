<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name='yandex-verification' content='4a3e9fdb2ed97f52' />

  <title>
    
      Главная &middot; MrDekk
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/mrdekk.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Noto+Serif:400,400italic,700,700italic&subset=latin,cyrillic-ext,latin-ext,cyrillic'>
  <link rel="stylesheet" href="/public/css/font-awesome.min.css" >

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="stylesheet" href="/public/css/tabs.css">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
	  <img class="profile" alt="my-profile" src="/media/images/brujo.jpg" width="120px">
      <h1>MrDekk</h1>
      <p class="description">Время - лучший учитель! Жаль, что оно убивает своих учеников...</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
        <a href="/"><i class="fa fa-home" ></i></a>
      </li>

      

      
      
        
          
        
      
        
          
            <li class="sidebar-nav-item">
              <a href="/about/">Кто здесь?</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
          
        
      
        
      
        
          
            <li class="sidebar-nav-item">
              <a href="/tags/">Метки</a>
            </li>
          
        
      
        
      
        
          
            <li class="sidebar-nav-item">
              <a href="/useful/">Полезное</a>
            </li>
          
        
      
        
      
        
          
        
      
        
          
            <li class="sidebar-nav-item">
              <a href="/awesome/">Awesome Stars</a>
            </li>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    </ul>

	<p class="social-icons">
		<!-- <a href="/search"><i class="fa fa-search fa-2x"></i></a> -->
		<a href="https://github.com/mrdekk"><i class="fa fa-github fa-2x"></i></a>
		<a href="https://twitter.com/mrdekk"><i class="fa fa-twitter fa-2x"></i></a>
		<a href="/atom.xml"><i class="fa fa-rss fa-2x"></i></a>
	</p>

    <p>&copy; 2024. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2024/04/08/notes-on-di/">
        Заметки о Dependency Injection
      </a>
    </h1>

    <i class="icon fa fa-calendar-o text-danger"></i><span class="post-date">08.04.2024</span>
	<i class="icon fa fa-tags text-success"></i><p class="entry-tags">
  	
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#swift" title="Pages tagged swift" rel="tag" class="text-success">swift</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#ios" title="Pages tagged ios" rel="tag" class="text-success">ios</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#kotlin" title="Pages tagged kotlin" rel="tag" class="text-success">kotlin</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#android" title="Pages tagged android" rel="tag" class="text-success">android</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#di" title="Pages tagged di" rel="tag" class="text-success">di</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#dependency+injection" title="Pages tagged dependency injection" rel="tag" class="text-success">dependency injection</a>
        </div>
        
      
    </p>

    <p>Тема внедрение зависимостей одна из краеугольных в целом при любой разработке. И, благодаря этому, одна из наиболее дискуссионных, порой доходящаяя до уровня “священных войн” между апологетами разных подходов. В этой статье постараюсь изложить свое видение подходов к решению проблем.</p>

<h2 id="преамбула">Преамбула</h2>

<p>Для того, чтобы не превращать эту статью в рассказ “от сотворения мира”, очень рекомендую посмотреть <a href="https://www.youtube.com/live/GA1NY-RKkhs?si=HBUhtDkeJZYBgfhX&amp;t=4399">это видео</a> (с указанного таймкода, лекция там в целом про архитектуру, но нас в рамках этой статьи будут интересовать выкладки про DI).</p>

<h2 id="постановка-проблемы">Постановка проблемы</h2>

<h3 id="базовая-задача">Базовая задача</h3>

<p>Итак, мы стараемся придумать решение следующей проблемы</p>

<ul id="task" class="tab" data-tab="e343ddfd-1010-4990-a6d2-3b0aff5100ba" data-name="task">
  
      <li class="active" id="task-swift">
          <a href="#">Swift </a>
      </li>
  
      <li id="task-kotlin">
          <a href="#">Kotlin </a>
      </li>
  
</ul>
<ul class="tab-content" id="e343ddfd-1010-4990-a6d2-3b0aff5100ba" data-name="task">
  
      <li class="active">
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">SomeBookService</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

<span class="kd">class</span> <span class="kt">BookProcessor</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">service</span><span class="p">:</span> <span class="kt">SomeBookService</span> <span class="o">=</span> <span class="kt">SomeBookServiceImpl</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

</li>
  
      <li>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">SomeBookService</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>

<span class="kd">class</span> <span class="nc">BookProcessor</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">service</span><span class="p">:</span> <span class="nc">SomeBookService</span> <span class="p">=</span> <span class="nc">SomeBookServiceImpl</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div></div>

</li>
  
</ul>

<p>Что мы хотим от хорошего решения?</p>

<ul>
  <li><strong>Через протокол/интерфейс.</strong> Использующий зависимость класс не должен знать о конкретной реализации и должен иметь работать с любой реализацией правильно реализующей контракт (объявленный в протоколе/интерфейсе).</li>
  <li><strong>Узкий контракт.</strong> Реализация, которую мы получаем в виде зависимости должена иметь минимально необходимый контракт. Наша сущность не должна видеть лишнего</li>
  <li><strong>Необходимость и достаточность.</strong> Поставляемые зафисимости поставляются в необходимом и достаточном объеме, не требуется каких-то специальных приседаний для того, чтобы получить что-то еще (это как правило относится к запрету использовать внутри синглтоны).</li>
  <li><strong>Реализация DI для логического кода “невидима”.</strong> Мы не должны видеть фрагменты порождающего кода где-либо (кроме некоторых исключений).</li>
</ul>

<h3 id="платформенные-особенности">Платформенные особенности</h3>

<p>Мы рассматриваем мобильные платформы (в целом можно рассматривать и серверные, но там как правило все проще в этом плане).</p>

<h4 id="ios">iOS</h4>

<p>Как правило, все сущности iOS позволяют нормально реализовать constructor injection паттерн без необходимости построения специальных решений. Иногда требуются специальные действия для создания циклических зависимостей, но они легко решаются способами, описанными ниже.</p>

<p>Единственный объект, который система создает сама - это UIApplication (и applicationDidFinishLaunchingWithOptions) или SwiftUI объект обозначенный как @main. Но эти объекты будем считать точкой входа и растить графы от них.</p>

<h4 id="android">Android</h4>

<p>У Android также как и в iOS есть главный объект создаваемый системой - Application, но есть и важное отличие - в Android есть объекты, которые фреймворком могут быть убиты и пересозданы через тривиальный конструктор, такие как Activity, Fragment, View и тд. И есть общепринятая практика использовать для иньекции зависимостей в такие объекты через паттерн Service Locator. Service Locator считаем антипаттерном (как минимум он противоречит принципам хорошего решения, упомянутым выше).</p>

<p>Поэтому для решение проблемы спец сущностей (которые могут быть пересозданы), в Android надо предусмотреть дополнительные средства.</p>

<h3 id="o-service-locatorе">O Service Locator’е</h3>

<p><a href="https://ru.wikipedia.org/wiki/Локатор_служб">Service Locator</a> это такой паттерн проектирования, который, упрощенно говоря, предоставляет единую точку, через которую можно запросить разные зависимости. В рамках создания библиотек для DI он обычно соседствует с паттерном <a href="https://ru.wikipedia.org/wiki/Одиночка_(шаблон_проектирования)">Singleton</a> предоставляя публично известный разделяемый объект, из которого можно запросить практически все что угодно.</p>

<p>Я считаю его антипаттерном в применении к задачам DI (у него есть другая применимость, которая норм).</p>

<p>Но чтобы не быть голословным, давайте рассмотрим поставленные требования к хорошему решению:</p>

<ul>
  <li><strong>Через протокол/интерфейс</strong> - эту задачу в целом можно решить, отдавая из публичного singleton’а сервис локатора интерфейсы</li>
  <li><strong>Узкий контракт</strong> - так как точка эта общеизвестная, то надо отдавать зависимость целиком, что нарушает принцип сужения контракта. Можно из публичного singleton’а отдавать одну реализацию под набором интерфейсов, но тогда у нас будет очень сложно выглядеть общий контракт такого объекта, сложно будет что-то в нем найти.</li>
  <li><strong>Необходимость и достаточность</strong> - мы показываем всевозмоюжные интерфейсы или даже реализации, что любой клиент может видеть все приложение, что явно нарушает это требование</li>
  <li><strong>“Невидимость”</strong> - требование явно нарушается, так как из любой точки приложения можно публичный singleton локатора</li>
</ul>

<p>Таким образом Service Locator использовать не стоит, поэтому будем строить решение на базе концепции контейнера.</p>

<h3 id="о-библиотечных-решениях">О библиотечных решениях</h3>

<p>В мире написано огромное количество библиотек, заявляющих что так или иначе решают проблему внедрения зависимостей. Однако большая часть из них основана на паттерне Service Locator. Справедливости ради стоит сказать, что наиболее популярная библиотека Dagger 2 для Android пытается использовать концепцию контейнера, и в Sevice Locator его чаще всего превращают при использовании.</p>

<h2 id="идея-решения-проблемы">Идея решения проблемы</h2>

<p>Как уже было сказано выше - будем использовать концепцию контейнера.</p>

<p>Контейнер - это такая сущность, которыя</p>

<ul>
  <li>Создает нужные объекты и управляет их временем жизни</li>
  <li>Настраивает связи между ними</li>
  <li>Невидима для самих объектов</li>
</ul>

<p>Каждая конкретная логическая сущность (кроме самих контейнеров) заявляет необходимость зависимостей (через constructor или property injection) и все. Никоим образом логическая сущность не получает доступа не к типу контейнера, ни к его инстансу (кроме как через Factory интерфейсы там где нужна prototype зависимость).</p>

<p>Отступление про нейминг. Однажды я увидел, как в коде контейнеры называют графами (Graph) и мне эта идея так понравилась, что далее буду называть типы контейнеров графами, можно в рамках этой заметки считать эти термины эквивалентными для задач DI.</p>

<p>Таким образом простейший контейнер может выглядеть так</p>

<ul id="container" class="tab" data-tab="c9c44b36-1f40-4dc4-81da-d83ce2ecca3b" data-name="container">
  
      <li class="active" id="container-swift">
          <a href="#">Swift </a>
      </li>
  
      <li id="container-kotlin">
          <a href="#">Kotlin </a>
      </li>
  
</ul>
<ul class="tab-content" id="c9c44b36-1f40-4dc4-81da-d83ce2ecca3b" data-name="container">
  
      <li class="active">
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">SomeGraph</span> <span class="p">{</span>

    <span class="c1">// 'singleton' entities</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">dep1</span><span class="p">:</span> <span class="kt">Dep1</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">dep2</span><span class="p">:</span> <span class="kt">Dep2</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">dep3</span><span class="p">:</span> <span class="kt">Dep3</span>

    <span class="c1">// other graphs</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">subGraph</span><span class="p">:</span> <span class="kt">SomeSubGraph</span>

    <span class="nf">init</span><span class="p">(</span>
        <span class="nv">someGraphDependencies</span><span class="p">:</span> <span class="kt">SomeGraphDependencies</span><span class="p">,</span>
        <span class="nv">someSpecificDependency</span><span class="p">:</span> <span class="kt">SomeSpecificDependency</span><span class="p">,</span>
        <span class="nv">configuration</span><span class="p">:</span> <span class="kt">SomeGraphConfiguration</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">dep1</span> <span class="o">=</span> <span class="kt">Dep1</span><span class="p">(</span>
            <span class="cm">/* ... */</span><span class="p">,</span>
            <span class="nv">makeSome</span><span class="p">:</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">makeSomePrototypeDep</span><span class="p">(</span><span class="nv">val</span><span class="p">:</span> <span class="n">configuration</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">dep2</span> <span class="o">=</span> <span class="kt">Dep2</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">,</span> <span class="nv">useVal</span><span class="p">:</span> <span class="n">configuration</span><span class="o">.</span><span class="n">useVal</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">dep3</span> <span class="o">=</span> <span class="kt">Dep3</span><span class="p">(</span><span class="nv">dep1</span><span class="p">:</span> <span class="kt">Dep1</span><span class="p">,</span> <span class="nv">dep2</span><span class="p">:</span> <span class="kt">Dep2</span><span class="p">)</span>
        <span class="c1">// ...</span>
        <span class="k">self</span><span class="o">.</span><span class="n">subGraph</span> <span class="o">=</span> <span class="kt">SomeSubGraph</span><span class="p">(</span>
            <span class="cm">/* ... */</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="c1">// тут некоторая логика очистки сущностей, которые того требуют</span>
    <span class="p">}</span>

    <span class="c1">// 'prototype' entities</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">makeSomePrototypeDep</span><span class="p">(</span><span class="nv">val</span><span class="p">:</span> <span class="kt">Val1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Dep4</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="k">return</span> <span class="kt">Dep4</span><span class="p">(</span>
            <span class="nv">val</span><span class="p">:</span> <span class="n">val</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

</li>
  
      <li>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SomeGraph</span><span class="p">(</span>
    <span class="n">someGraphDependencies</span><span class="p">:</span> <span class="nc">SomeGraphDependencies</span><span class="p">,</span>
    <span class="n">someSpecificDependency</span><span class="p">:</span> <span class="nc">SomeSpecificDependency</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">configuration</span><span class="p">:</span> <span class="nc">SomeGraphConfiguration</span><span class="p">,</span>
    <span class="o">..</span><span class="p">.</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 'singleton' entities</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">dep1</span><span class="p">:</span> <span class="nc">Dep1</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">dep2</span><span class="p">:</span> <span class="nc">Dep2</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">dep3</span><span class="p">:</span> <span class="nc">Dep3</span>

    <span class="c1">// other graphs</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">subGraph</span><span class="p">:</span> <span class="nc">SomeSubGraph</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dep1</span> <span class="p">=</span> <span class="nc">Dep1</span><span class="p">(</span>
            <span class="cm">/* ... */</span><span class="p">,</span>
            <span class="n">makeSome</span> <span class="p">=</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">makeSomePrototypeDep</span><span class="p">(</span><span class="kd">val</span> <span class="err">=</span> <span class="py">configuration</span><span class="p">.</span><span class="k">val</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dep2</span> <span class="p">=</span> <span class="nc">Dep2</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">,</span> <span class="n">useVal</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">.</span><span class="n">useVal</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dep3</span> <span class="p">=</span> <span class="nc">Dep3</span><span class="p">(</span><span class="n">dep1</span> <span class="p">=</span> <span class="nc">Dep1</span><span class="p">,</span> <span class="n">dep2</span> <span class="p">=</span> <span class="nc">Dep2</span><span class="p">)</span>
        <span class="c1">// ...</span>
        <span class="k">this</span><span class="p">.</span><span class="n">subGraph</span> <span class="p">=</span> <span class="nc">SomeSubGraph</span><span class="p">(</span>
            <span class="cm">/* ... */</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">cleanup</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// в Java/Kotlin нет полноценных деструкторов, поэтому cleanup методы</span>
        <span class="c1">// необходимо будет вызывать руками</span>
        <span class="c1">// тут некоторая логика очистки сущностей, которые того требуют</span>
    <span class="p">}</span>

    <span class="c1">// 'prototype' entities</span>
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">makeSomePrototypeDep</span><span class="p">(</span><span class="k">val</span><span class="p">:</span> <span class="nc">Val1</span><span class="p">):</span> <span class="nc">Dep4</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="k">return</span> <span class="nc">Dep4</span><span class="p">(</span>
            <span class="kd">val</span> <span class="err">=</span> <span class="py">val</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

</li>
  
</ul>

<p>И все - собирайте нужную конструкцию из иерархических графов. Когда какой-то набор сущностей станет ненужным - зануляете граф и все очищается (в Android не забываем звать cleanup).</p>

<p>PROFIT? не совсем, есть тонкости</p>

<h3 id="ios-1">iOS</h3>

<p>В iOS как правило все проходит без проблем. Мы создаем корневой граф-контейнер в applicationWill/DidLaunchingWithOptions и передаем его целиком или частями в дальнейшие сущности, или создаем его в корневом объекте помеченном @main и также передаем целиком или частями дальше. Главное не забывать о сужении интерфейсов и принципе достаточной необходимости.</p>

<h3 id="android-1">Android</h3>

<p>Для бизнесовых сущностей достаточно также в рамках класса Application создать корневой граф и действовать аналогично iOS, но, как я уже выше упоминал, есть проблемы с андроидными сущностями. Поэтому для них нужно специальное решение.</p>

<p>Заведем пару контрактов</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// любая сущность, в которую наш DI сможет что-то инжектить</span>
<span class="kd">interface</span> <span class="nc">Injectable</span>

<span class="c1">// контракт сущности контейнера, который сможет что-то куда-то инжектить</span>
<span class="kd">interface</span> <span class="nc">Injector</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">inject</span><span class="p">(</span><span class="n">into</span><span class="p">:</span> <span class="nc">Injectable</span><span class="p">)</span> <span class="c1">// можно опционально return Result</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Чуть выше в разделе про Service Locator я уже говорил, что основная проблема в нем в том, что</p>

<ul>
  <li>его shared instance известен публично, и может быть использован скрыто. С этим увы ничего не поделать, андроидные компоненты устроены так, что нам придется пойти на открытие какого-то shared instance. Для activity/fragment есть лазейка, о ней чуть позже, но в общем итоге не поделать ничего.</li>
  <li>из него можно достать что угодно, эту проблему будем решать.</li>
</ul>

<p>Также важно, что для Android компонентов инъекция будет асинхронной относительно вызова конструктора объектов, поэтому полноценную compile time проверку мы сделать не сможем. Ограничимся сокрытием лишней информации.</p>

<p>Теперь нам нужно предусмотреть сущность, которую мы будем видеть через shared instance, но не моч из нее ничего достать</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SomeGraph</span> <span class="k">private</span> <span class="k">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">dependency</span><span class="p">:</span> <span class="nc">SomeDependnecy</span><span class="p">,</span>
    <span class="c1">// other deps</span>
<span class="p">):</span> <span class="nc">Injector</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">inject</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nc">Injectable</span><span class="p">)</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">is</span> <span class="nc">SomeKnownFragment</span> <span class="p">-&gt;</span> <span class="p">{</span>
            <span class="n">target</span><span class="p">.</span><span class="n">dependency</span> <span class="p">=</span> <span class="n">dependency</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="p">{</span>
            <span class="c1">// report error in some kind</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="py">sharedInstance</span><span class="p">:</span> <span class="nc">SomeGraph</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
            <span class="k">private</span> <span class="k">set</span>

        <span class="k">fun</span> <span class="nf">setup</span><span class="p">(</span>
            <span class="n">dependency</span><span class="p">:</span> <span class="nc">SomeDependency</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="nf">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sharedInstance</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                <span class="n">sharedInstance</span> <span class="p">=</span> <span class="nc">SomeGraph</span><span class="p">(</span>
                    <span class="n">dependency</span> <span class="p">=</span> <span class="n">dependency</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>И теперь в условном фрагменте мы можем написать так</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SomeKnownFragment</span><span class="p">:</span> <span class="nc">Fragment</span><span class="p">(),</span> <span class="nc">Injectable</span> <span class="p">{</span>

    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">dependency</span><span class="p">:</span> <span class="nc">Dependency</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAttach</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onAttach</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="nc">SomeGraph</span><span class="p">.</span><span class="n">sharedInstance</span><span class="o">?.</span><span class="nf">inject</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Как я уже сказал, есть некоторая проблема в том, что связывание будет проверено только в runtime, а правильнее было бы сделать в compile time, но архитектура компонентов Android’а тут этому препятствует.</p>

<p>К слову такой подход хорошо подходит для библиотек, этот SomeGraph может быть объектов библиотеки, которую надо проинициализировать и потом сама библиотека будет ее использовать. Для Activity/Fragment и тд можем сделать лучше, для этого нам потребуется еще немножко сахара (покажу на примере Activity, для фрагментов можно сделать аналогично)</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nc">Activity</span><span class="p">.</span><span class="nf">inject</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">thisAsInjectable</span> <span class="p">=</span> <span class="k">this</span> <span class="k">as</span><span class="p">?</span> <span class="nc">Injectable</span> <span class="o">?:</span> <span class="k">throw</span> <span class="nc">InjectException</span><span class="p">(</span><span class="s">"activity not injectable"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">application</span> <span class="p">=</span> <span class="n">application</span> <span class="o">?:</span> <span class="k">throw</span> <span class="nc">InjectException</span><span class="p">(</span><span class="s">"application isn't set to activity"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">injector</span> <span class="p">=</span> <span class="n">application</span> <span class="k">as</span><span class="p">?</span> <span class="nc">Injector</span> <span class="o">?:</span> <span class="k">throw</span> <span class="nc">InjectException</span><span class="p">(</span><span class="s">"application is not an injector"</span><span class="p">)</span>
    <span class="n">injector</span><span class="p">.</span><span class="nf">inject</span><span class="p">(</span><span class="n">thisAsInjectable</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>теперь надо класс приложения разметить соответствующим образом</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">YourApp</span><span class="p">:</span> <span class="nc">Application</span><span class="p">(),</span> <span class="nc">Injector</span> <span class="p">{</span>

    <span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">rootGraph</span><span class="p">:</span> <span class="nc">RootGraph</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">()</span>
        <span class="n">rootGraph</span> <span class="p">=</span> <span class="nc">RootGraph</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">inject</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nc">Injectable</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="o">::</span><span class="n">graph</span><span class="p">.</span><span class="n">isInitialized</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">error</span><span class="p">(</span><span class="s">"Application isn't properly initialized yet"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">graph</span><span class="p">.</span><span class="nf">inject</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>корневой граф будет выглядеть примерно так</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">RootGraph</span><span class="p">(</span>
    <span class="n">applicationContext</span><span class="p">:</span> <span class="nc">Context</span>
<span class="p">):</span> <span class="nc">Injector</span> <span class="p">{</span>

    <span class="c1">// private val yourdeps = ...</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="c1">// тут инициализация нужных компонентов</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">inject</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nc">Injectable</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">when</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">is</span> <span class="nc">MainActivity</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="n">target</span><span class="p">.</span><span class="n">depepdency</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>
            <span class="p">}</span>
            <span class="c1">// можно делегировать что-то субграфам</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>И в самой активити будет просто</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="nc">Activity</span><span class="p">(),</span> <span class="nc">Injectable</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>

        <span class="nf">inject</span><span class="p">()</span>

        <span class="c1">// остальная инициализация</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Никаких синглетонов и никакого раскрытия лишних зависимостей - PROFIT.</p>

<p>P.S. Если придумаете как решить эту проблему с аналогичными гарантиями да еще и в compile time буду благодарен</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2019/11/06/swift-dependency-injection/">
        Внедрение зависимостей (dependency injection) в Swift 5.1
      </a>
    </h1>

    <i class="icon fa fa-calendar-o text-danger"></i><span class="post-date">06.11.2019</span>
	<i class="icon fa fa-tags text-success"></i><p class="entry-tags">
  	
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#swift" title="Pages tagged swift" rel="tag" class="text-success">swift</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#ios" title="Pages tagged ios" rel="tag" class="text-success">ios</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#di" title="Pages tagged di" rel="tag" class="text-success">di</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#dependency+injection" title="Pages tagged dependency injection" rel="tag" class="text-success">dependency injection</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#property+wrappers" title="Pages tagged property wrappers" rel="tag" class="text-success">property wrappers</a>
        </div>
        
      
    </p>

    <p>Внедрение зависимостей очень горячая тема в любой области разработки, где мы пишем что-то более сложное чем Hello, World. Однако несмотря на казалось бы изученный вдоль и поперек вопрос, вариантов его решения вы можете на просторах интернета найти великое множество. И в каждом месте оно подается как единственно правильное. И как же выбрать? Предлагаю в этой статье немножко рассмотреть подходы, их плюсы и минусы, немножко поиграться со Swift’ом вообще и попробовать его новые фичи в виде @PropertyWrapper’s.</p>

<p>Итак, постановка задачи у нас будет такая - у нас есть два класса BooksRenderer, который просто каким-то образом рисует книжки, и BooksProvider, который ему их поставляет. На Swift это будет выглядеть примерно так:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">BooksRenderer</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">provider</span><span class="p">:</span> <span class="kt">BooksProvider</span> <span class="o">=</span> <span class="o">...</span> <span class="cm">/* за это троеточие и будет вестись основная борьба */</span>

    <span class="kd">func</span> <span class="nf">draw</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">books</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">books</span>
        <span class="cm">/* тут каким-то образом рисуются книги из массива books */</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">BooksProvider</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">books</span><span class="p">:</span> <span class="p">[</span><span class="kt">Book</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Будем также считать что есть некая реализация протокола BooksProvider, например такая наивная</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">NaiveBooksProvider</span><span class="p">:</span> <span class="kt">BooksProvider</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">books</span><span class="p">:</span> <span class="p">[</span><span class="kt">Book</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="kt">Book</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="s">"Dune"</span><span class="p">,</span> <span class="nv">author</span><span class="p">:</span> <span class="s">"Frank Herbert"</span><span class="p">),</span>
            <span class="kt">Book</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="s">"Lord of the Rings"</span><span class="p">,</span> <span class="nv">author</span><span class="p">:</span> <span class="s">"John R.R. Tolkien"</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Теперь наша задача каким-то образом доставить экземпляр класса NaiveBooksProvider в BooksRenderer. Самый наивный подход такой, создать экземлляр класса прямо на месте:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">BooksRenderer</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">provider</span><span class="p">:</span> <span class="kt">BooksProvider</span> <span class="o">=</span> <span class="kt">NaiveBooksProvider</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Несмотря на то, что этот подход, каким бы наивным он не был, много где применяется, у него есть очевидные недостатки:</p>

<ol>
  <li>Мы можем захотеть как-то менять конкретный класс реализации, а он тут “прибит гвоздями”</li>
  <li>Мы можем захотеть unit-протестировать класс BooksRenderer, и тогда вместо провайдера захотим вставить какой-нибудь мок
и т.д.</li>
</ol>

<p>Нам надо что-то лучше. И много где предлагают хорошо известный паттер ServiceLocator. Если его применить, то выглядеть это будет примерно так:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">ServiceLocator</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">booksProvider</span><span class="p">:</span> <span class="kt">BooksProvider</span> <span class="o">=</span> <span class="kt">NaiveBooksProvider</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">BooksRenderer</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">provider</span><span class="p">:</span> <span class="kt">BooksProvider</span> <span class="o">=</span> <span class="kt">ServiceLocator</span><span class="o">.</span><span class="n">booksProvider</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Уже лучше, ответственность за выбор конкретного класса мы достали из BooksRenderer и наделили этой почетной обязанностью класс ServiceLocator. И мы даже можем сделать разные ServiceLocator’ы для основного приложения и для тестов, которые будут создавать разные BooksProvider’ы, однако:</p>

<ol>
  <li>Теперь 90% кода будет знать про класс ServiceLocator</li>
  <li>Класс ServiceLocator будет огромным (кто там что говорил про Massive View Controller?, у нас тут Massive Service Locator)</li>
</ol>

<p>Прежде чем пойти дальше, давайте сделаем некоторое лирическое отступление, разберемся в терминологии зависимостей. Вообще внедряемых зависимостей может быть два типа: прости хоспади singleton (но это не то что вы подумали) и prototype. “singleton” зависимости - это такие зависимости, которые сколько бы вы не внедряли в рамках одного конкретного модуля, это всегда будет один экземпляр. “prototype” же - даст на каждую точку внедрения новый экземпляр.</p>

<p>Поэтому если говорить про наш пример с ServiceLocator’ом, то например booksProvider - это singleton зависимость, а bookUpdateOperation - prototype:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">ServiceLocator</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">booksProvider</span><span class="p">:</span> <span class="kt">BooksProvider</span> <span class="o">=</span> <span class="kt">NaiveBooksProvider</span><span class="p">()</span>

    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">bookUpdateOperation</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Operation</span> <span class="o">&amp;</span> <span class="kt">BookUpdate</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">NaiveBookUpdateOperation</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Теперь давайте сделаем еще одно лирическое отступление, подчерпнутое мной когда я еще занимался “кровавым” enterprise и работал с <a href="http://spring.io">Srping Framework</a>. Хороший DI контейнер это такой контейнер, который не видно. Тут можно еще пофилософствовать и вспомнить <a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=3&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjEo_P2mdblAhV8wsQBHaObD_EQFjACegQIDRAG&amp;url=https%3A%2F%2Fru.wikipedia.org%2Fwiki%2F%25D0%25A2%25D0%25B5%25D0%25BE%25D1%2580%25D0%25B8%25D1%258F_%25D1%2580%25D0%25B5%25D1%2588%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B7%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B5%25D1%2582%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D1%2581%25D0%25BA%25D0%25B8%25D1%2585_%25D0%25B7%25D0%25B0%25D0%25B4%25D0%25B0%25D1%2587&amp;usg=AOvVaw0VcQvVNp9cBvIu5iqYojs9">ТРИЗ</a> с ее идеальным конечным результатом, который на наш DI’ный контекст перефразируется так: “хороший DI контейнер - это такой, которого нет, а зависимости внедряются”.</p>

<p>Таким образом, можно сделать такой DI на базе initializer injection (оно лучше property injection, потому что компилятор в этом случае не даст вам озорничать, а с property injection легко забыть что-нибудь присвоить и грохнуться в рантайме):</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">AppContainer</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">booksProvider</span><span class="p">:</span> <span class="kt">BooksProvider</span>

    <span class="nf">init</span><span class="p">(</span><span class="n">with</span> <span class="nv">appDelegate</span><span class="p">:</span> <span class="kt">AppDelegate</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">booksProvider</span> <span class="o">=</span> <span class="kt">NaiveBooksProvider</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="n">appDelegate</span><span class="o">.</span><span class="n">booksRenderer</span> <span class="o">=</span> <span class="kt">BooksRenderer</span><span class="p">(</span><span class="nv">provider</span><span class="p">:</span> <span class="n">booksProvider</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">@UIApplicationMain</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">UIResponder</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">container</span><span class="p">:</span> <span class="kt">AppContainer</span>
    <span class="k">var</span> <span class="nv">booksRenderer</span><span class="p">:</span> <span class="kt">BooksRenderer</span><span class="o">!</span>

    <span class="kd">func</span> <span class="nf">applicationDidFinishLauncherWithOptions</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">container</span> <span class="o">=</span> <span class="kt">AppContainer</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">BooksRenderer</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">provider</span><span class="p">:</span> <span class="kt">BooksProvider</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">provider</span><span class="p">:</span> <span class="kt">BooksProvider</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Причем такой подход будет гарантировать вам проверку компилятором. И при этом про AppContainer будет знать только AppDelegate. Да, корневые зависимости в самом AppDelegate’е будут force unwrapped (что исть не хорошо, но лучше я не придумал), но эта вольность доступна только тут.</p>

<p>prootype зависимости в таком подходе можно оформить либо в виде фабрики</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">SomeFactory</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">superDep</span><span class="p">:</span> <span class="kt">SuperDep</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">superDep</span><span class="p">:</span> <span class="kt">SuperDep</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">superDep</span> <span class="o">=</span> <span class="n">superDep</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">makeSomeDep</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">SomeDep</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">SomeDep</span><span class="p">(</span><span class="n">superDep</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>и потом внедрять это фабрику как singleton зависимость туда где нужно генерить prototype’ные, или в виде замыкания</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">typealias</span> <span class="kt">SomeFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span> <span class="nv">superDep</span><span class="p">:</span> <span class="kt">SuperDep</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">SomeDep</span> <span class="p">{</span> <span class="kt">SomeDep</span><span class="p">(</span><span class="n">superDep</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>и также ее внедрять как singleton зависимость.</p>

<p>Но я обещал немножко Swift 5.1 и @PropertyWrapper, их легко сделать так (пусть будет наш пример с ServiceLocator’ом, хотя его можно легко модифицировать):</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@propertyWrapper</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="kt">Inject</span><span class="o">&lt;</span><span class="kt">Dep</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">kept</span><span class="p">:</span> <span class="kt">Dep</span><span class="p">?</span>

    <span class="kd">public</span> <span class="k">var</span> <span class="nv">wrappedValue</span><span class="p">:</span> <span class="kt">Dep</span> <span class="p">{</span>
        <span class="n">kept</span> <span class="p">??</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">dependency</span><span class="p">:</span> <span class="kt">Dep</span> <span class="o">=</span> <span class="kt">ServiceLocator</span><span class="o">.</span><span class="nf">resolve</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">kept</span> <span class="o">=</span> <span class="n">dependency</span>
            <span class="k">return</span> <span class="n">dependency</span>
        <span class="p">}()</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">convenience</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">ServiceLocator</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="n">register</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">for</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">resolver</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// register</span>
    <span class="p">}</span>

    <span class="kd">static</span> <span class="kd">func</span> <span class="n">resolve</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">for</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">T</span> <span class="p">{</span>
        <span class="c1">// do some magic</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">BooksRenderer</span> <span class="p">{</span>
    <span class="kd">@Inject</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">provider</span><span class="p">:</span> <span class="kt">BooksProvider</span>
<span class="p">}</span>
</code></pre></div></div>

<p>И вуаля! Однако несмотря на всю прелесть такой магии, есть проблема в месте где творится магия (“do some magic”). Если вы вдруг забыли сделать register, то упс, вы получаете рантайм крэш. И сделать это красиво с compile time check непонятно как, так как регистрация динамическая.</p>

<p>Предлагаю подискутировать, оформляйте issues <a href="https://github.com/mrdekk/mrdekk.github.io">тут</a></p>

<p>P.S.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2019/05/08/clang8-dev-vscode-ubuntu-docker/">
        Разрабатываем и отлаживаем С++ в Docker с помощью VSCode (2019 edition - clang8 lldb)
      </a>
    </h1>

    <i class="icon fa fa-calendar-o text-danger"></i><span class="post-date">08.05.2019</span>
	<i class="icon fa fa-tags text-success"></i><p class="entry-tags">
  	
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#c%2B%2B" title="Pages tagged c++" rel="tag" class="text-success">c++</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#linux" title="Pages tagged linux" rel="tag" class="text-success">linux</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#ubuntu" title="Pages tagged ubuntu" rel="tag" class="text-success">ubuntu</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#gcc" title="Pages tagged gcc" rel="tag" class="text-success">gcc</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#vscode" title="Pages tagged vscode" rel="tag" class="text-success">vscode</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#clang" title="Pages tagged clang" rel="tag" class="text-success">clang</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#lldb" title="Pages tagged lldb" rel="tag" class="text-success">lldb</a>
        </div>
        
      
    </p>

    <p>Какое-то время назад я написал статью <a href="/2018/01/06/vscode-cpp-docker-debugging/">Разрабатываем и отлаживаем С++ в Docker с помощью VSCode</a> в котором для сборки использовался gcc и для отладки gdbserver. В этом обновленном посте хочу затронуть такой же вопрос, но уже на базе clang 8 и lldb-server.</p>

<p>Также в отличии от предыдущей статьи мы не будем каждый раз пересоздавать контейнер, а запустим его один раз и будет с ним работать через <code class="language-plaintext highlighter-rouge">docker exec</code>.</p>

<p>Итак, начнем, Dockerfile</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM ubuntu:18.04

RUN apt-get update 
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential xz-utils curl cmake
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y lldb

RUN curl -SL http://releases.llvm.org/8.0.0/clang+llvm-8.0.0-x86_64-linux-gnu-ubuntu-18.04.tar.xz | tar -xJC . &amp;&amp; \
    mv clang+llvm-8.0.0-x86_64-linux-gnu-ubuntu-18.04 clang_8.0.0 &amp;&amp; \
    mv clang_8.0.0 /usr/local

ENV PATH="/usr/local/clang_8.0.0/bin:${PATH}"
ENV LD_LIBRARY_PATH="/usr/local/clang_8.0.0/lib:${LD_LIBRARY_PATH}"

WORKDIR /opt/build
VOLUME ["/opt"]

</code></pre></div></div>

<p>lldb (для lldb-server) используем поставляемый в пакетах (на момент написания статьи для 18.04 это был LLDB 6). Также из пакетов ставим cmake (вроде ничего специфичного пока не надо). clang ставим руками, но уже собранный.</p>

<p>Дальше нам нужен скрипт сборки контейнера (/scripts/docker_build.sh)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

cwd=$(pwd)

docker build \
    -t something/cmaker \
    .
</code></pre></div></div>

<p>И таска для vscode</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "label": "build docker container",
    "command": "${workspaceFolder}/scripts/docker_build.sh"
}
</code></pre></div></div>

<p>после этого нам понадобится запустить контейнер для последующего использования, для этого нам нужен скрипт (/scripts/docker_run.sh). Тут попутно запускается lldb-server, о нем позже:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

cwd=$(pwd)

docker stop сmaker
docker rm сmaker
docker run \
    -dt \
    --name сmaker \
    -p 7000:7000 \
    -p 7001:7001 \
    -p 7002:7002 \
    -p 7003:7003 \
    -v ${cwd}:/opt \
    --privileged \
    something/cmaker \
    "${@}"

</code></pre></div></div>

<p>и таска для vscode</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "label": "run container for future builds",
    "command": "${workspaceFolder}/scripts/docker_run.sh",
    "args": [
        "lldb-server", "platform", "--server", "--listen=0.0.0.0:7000", "-m", "7001", "-M", "7003"
    ],
    "options": {
        "cwd": "${workspaceFolder}"
    }
}
</code></pre></div></div>

<p>После этого можем приступать к сборке проекта. Структуру проекта сразу предусмотрел для многомодульного проекта</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include
scripts
  docker_build.sh
  docker_run.sh
hword
  include
  CMakeLists.txt
  main.cpp
CMakeLists.txt
Dockerfile
</code></pre></div></div>

<p>Корневой CMakeLists.txt выглядит так</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmake_minimum_required(VERSION 3.0)
project(something)

set(CMAKE_BINARY_DIR ${CMAKE_SOURCE_DIR}/build)

set(EXECUTABLE_OUTPUT_PATH ${CMAKE_BINARY_DIR})
set(LIBRARY_OUTPUT_PATH ${CMAKE_BINARY_DIR})

set(PROJECT_INCLUDE_DIR ${PROJECT_SOURCE_DIR}/include)

include_directories("${PROJECT_INCLUDE_DIR}")
include_directories("${PROJECT_SOURCE_DIR}")

add_subdirectory(hword)
</code></pre></div></div>

<p>CMakeLists.txt для hword выглядит так</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmake_minimum_required(VERSION 3.0)
project(hword)

set(PROJECT_INCLUDE_DIR ${PROJECT_SOURCE_DIR}/include)
set(HWORD_VERSION_MAJOR 1)
set(HWORD_VERSION_MINOR 0)

set(PROJECT_HWORD_SRCS
${PROJECT_SOURCE_DIR}/main.cpp
)

include_directories("${PROJECT_BINARY_DIR}")
add_executable(${PROJECT_NAME}_r ${PROJECT_HWORD_SRCS})
include_directories("${PROJECT_INCLUDE_DIR}")
</code></pre></div></div>

<p>Обратите внимание что к имени проекта добавлен постфикс <code class="language-plaintext highlighter-rouge">_r</code></p>

<p>Для примера содержимое main.cpp</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;unistd.h&gt;
#include &lt;limits.h&gt;

#include &lt;iostream&gt;

using namespace std;

static const int HNAME_MAX = 512;
static const int LNAME_MAX = 512;

int main()
{
    char hostname[HNAME_MAX];
    char username[LNAME_MAX];
    gethostname(hostname, HNAME_MAX);
    getlogin_r(username, LNAME_MAX);

    cout &lt;&lt; "hostname: " &lt;&lt; hostname &lt;&lt; ", username: " &lt;&lt; username &lt;&lt; endl;
    return 0;
}
</code></pre></div></div>

<p>Теперь соберем все это дело, запустим и отладим</p>

<p>Нам понадобится скрипт для <code class="language-plaintext highlighter-rouge">docker exec</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

cwd=$(pwd)

docker exec \
    -it \
    cmaker \
    "${@}"

</code></pre></div></div>

<p>Таска для cmake</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "label": "cmake initialize scripts (Makefile, Debug)",
    "command": "${workspaceFolder}/scripts/docker_exec.sh",
    "args": [                
        "cmake", "-G", "Unix Makefiles", 
        "-DCMAKE_BUILD_TYPE=Debug", 
        "-DCMAKE_C_COMPILER=/usr/local/clang_8.0.0/bin/clang",
        "-DCMAKE_CXX_COMPILER=/usr/local/clang_8.0.0/bin/clang++",
        "/opt"
    ],
    "options": {
        "cwd": "${workspaceFolder}"
    }
}
</code></pre></div></div>

<p>Обратите внимание, что тут явным образом указаны пути до компиляторов, это очень важно.</p>

<p>Далее таска для сборки всего проекта и для сборки конкретного</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "label": "make full project",
    "command": "${workspaceFolder}/scripts/docker_exec.sh",
    "args": [
        "make", "-j", "8"
    ],
    "options": {
        "cwd": "${workspaceFolder}"
    }
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "label": "make (hword) project",
    "command": "${workspaceFolder}/scripts/docker_exec.sh",
    "args": [
        "make", "-j", "8", "hword_r"
    ],
    "options": {
        "cwd": "${workspaceFolder}"
    }
}
</code></pre></div></div>

<p>И для простого запуска</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "label": "run (hword) project",
    "command": "${workspaceFolder}/scripts/docker_exec.sh",
    "args": [
        "/opt/build/hword_r"
    ]
}
</code></pre></div></div>

<p>С отладкой есть несколько проблем. Во-первых, кроме порта на котором слушает lldb-server надо пробросить еще несколько, на которых будет работать собственно соединение (для этого при запуске контейнера несколько опций <code class="language-plaintext highlighter-rouge">-p</code>). Во-вторых, lldb-server’у этот диапазон портов надо явно задать. И в третьих, надо правильно написать launch.json, выглядит он так:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "name": "debug: hword",
    "type": "lldb",
    "request": "launch",
    "program": "/opt/build/hword_r",
    "initCommands": [
        "platform select remote-linux",
        "platform connect connect://127.0.0.1:7000"
    ],
    "cwd": "/opt",
    "sourceMap": { 
        "/opt" : "${workspaceFolder}" 
    }
}
</code></pre></div></div>

<p>Жмем F5 и выуля - мы в отладке. Надеюсь это поможет :)</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/11/28/swift-kotlin-comparison/">
        Сравнение Swift vs Kotlin
      </a>
    </h1>

    <i class="icon fa fa-calendar-o text-danger"></i><span class="post-date">28.11.2018</span>
	<i class="icon fa fa-tags text-success"></i><p class="entry-tags">
  	
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#swift" title="Pages tagged swift" rel="tag" class="text-success">swift</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#ios" title="Pages tagged ios" rel="tag" class="text-success">ios</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#kotlin" title="Pages tagged kotlin" rel="tag" class="text-success">kotlin</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#android" title="Pages tagged android" rel="tag" class="text-success">android</a>
        </div>
        
      
    </p>

    <p>Небольшая табличка сравнения кода на Swift и кода на Kotlin для справки. Этакий cheet sheet.</p>

<h3 id="переменные-и-константы">Переменные и константы</h3>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">a</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">var</span> <span class="nv">b</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">20</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">a</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">10</span>
<span class="kd">var</span> <span class="py">b</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">20</span>
</code></pre></div></div>

<h4 id="optionals">Optionals</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">some</span><span class="p">:</span> <span class="kt">Something</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="k">var</span> <span class="nv">some</span><span class="p">:</span> <span class="kt">Something</span><span class="p">?</span> <span class="o">=</span> <span class="kt">Something</span><span class="p">(</span><span class="nv">text</span><span class="p">:</span> <span class="s">"Hello"</span><span class="p">)</span>

<span class="c1">// optional chaining</span>
<span class="k">let</span> <span class="nv">greeting</span> <span class="o">=</span> <span class="kd">some</span><span class="p">?</span><span class="o">.</span><span class="nf">greet</span><span class="p">()</span>

<span class="c1">// elvis</span>
<span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="kd">some</span><span class="p">?</span><span class="o">.</span><span class="n">value</span> <span class="p">??</span> <span class="mi">30</span>

<span class="c1">// optional unwraping</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">some</span> <span class="o">=</span> <span class="kd">some</span> <span class="p">{</span>
    <span class="nf">print</span><span class="p">(</span><span class="kd">some</span><span class="p">)</span> <span class="c1">// some is not optional</span>
<span class="p">}</span>

<span class="c1">// force unwraping</span>
<span class="k">let</span> <span class="nv">forced</span> <span class="o">=</span> <span class="kd">some</span><span class="o">!</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">some</span><span class="p">:</span> <span class="nc">Something</span><span class="p">?</span> <span class="p">=</span> <span class="n">nil</span>
<span class="kd">var</span> <span class="py">some</span><span class="p">:</span> <span class="nc">Something</span><span class="p">?</span> <span class="p">=</span> <span class="nc">Something</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">)</span>

<span class="c1">// optional chaining</span>
<span class="kd">val</span> <span class="py">greeting</span> <span class="p">=</span> <span class="n">some</span><span class="o">?.</span><span class="nf">greet</span><span class="p">()</span>

<span class="c1">// elvis</span>
<span class="kd">val</span> <span class="py">value</span> <span class="p">=</span> <span class="n">some</span><span class="o">?.</span><span class="n">value</span> <span class="o">?:</span> <span class="mi">30</span>

<span class="c1">// optional unwraping</span>
<span class="n">some</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span> <span class="n">some</span> <span class="p">-&gt;</span> <span class="c1">// it if name is not provided</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">some</span><span class="p">)</span> <span class="c1">// some is not optional</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">some</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">some</span><span class="p">)</span> <span class="c1">// some is smart casted and not optional</span>
<span class="p">}</span>

<span class="c1">// force unwraping</span>
<span class="kd">val</span> <span class="py">forced</span> <span class="p">=</span> <span class="n">some</span><span class="o">!!</span>
</code></pre></div></div>

<h3 id="форматирование-кода">Форматирование кода</h3>

<h4 id="скобки-круглые-и-фигурные">Скобки (круглые и фигурные)</h4>

<p>Swift</p>

<ul>
  <li>Круглые - не обязательны</li>
  <li>Фигурные - обязательны</li>
</ul>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">str</span> <span class="o">=</span> <span class="s">"Hello, Swift"</span>

<span class="kd">func</span> <span class="nf">increse</span><span class="p">(</span><span class="n">_</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">statements</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nf">increase</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">str</span> <span class="o">==</span> <span class="s">"something"</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kotlin</p>

<ul>
  <li>Круглые - обязательны</li>
  <li>Фигурные - не обязательны</li>
</ul>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">str</span> <span class="p">=</span> <span class="s">"Hello, Kotlin"</span>

<span class="k">fun</span> <span class="nf">increase</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">=</span> <span class="n">value</span> <span class="p">+</span> <span class="mi">1</span>

<span class="k">fun</span> <span class="nf">statements</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="py">i</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="n">i</span> <span class="p">=</span> <span class="nf">increase</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="p">==</span> <span class="s">"something"</span><span class="p">)</span> <span class="nf">print</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="управляющие-конструкции">Управляющие конструкции</h3>

<h4 id="pattern-matching">Pattern Matching</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">number</span> <span class="o">=</span> <span class="mi">42</span>
<span class="k">switch</span> <span class="n">number</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">...</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="s">"1 digit"</span><span class="p">)</span>
    <span class="k">case</span> <span class="mi">10</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="s">"2 digits"</span><span class="p">)</span>
    <span class="k">case</span> <span class="mi">11</span><span class="o">...</span><span class="mi">99</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="s">"2 digits"</span><span class="p">)</span>
    <span class="k">case</span> <span class="mi">100</span><span class="o">...</span><span class="mi">999</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="s">"3 digits"</span><span class="p">)</span>
    <span class="k">default</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="s">"4 or more digits"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">number</span> <span class="p">=</span> <span class="mi">42</span>
<span class="k">when</span> <span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span> <span class="p">-&gt;</span> <span class="nf">println</span><span class="p">(</span><span class="s">"1 digit"</span><span class="p">)</span>
    <span class="mi">10</span> <span class="p">-&gt;</span> <span class="nf">println</span><span class="p">(</span><span class="s">"2 digits"</span><span class="p">)</span>
    <span class="k">in</span> <span class="mi">11</span><span class="o">..</span><span class="mi">99</span> <span class="p">-&gt;</span> <span class="nf">println</span><span class="p">(</span><span class="s">"2 digits"</span><span class="p">)</span>
    <span class="k">in</span> <span class="mi">100</span><span class="o">..</span><span class="mi">999</span> <span class="p">-&gt;</span> <span class="nf">println</span><span class="p">(</span><span class="s">"3 digits"</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">-&gt;</span> <span class="nf">println</span><span class="p">(</span><span class="s">"4 or more digits"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="if-when--expressions-not-statements-">if, when = expressions, not statements (!)</h4>

<p>Swift</p>

<ul>
  <li>Не применимо</li>
</ul>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">test</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="s">"Test"</span> <span class="k">else</span> <span class="s">"False"</span>

<span class="kd">val</span> <span class="py">state</span> <span class="p">=</span> <span class="nc">State</span><span class="p">.</span><span class="nc">Off</span>
<span class="k">fun</span> <span class="nf">decide</span><span class="p">()</span> <span class="p">=</span> <span class="k">when</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">State</span><span class="p">.</span><span class="nc">Off</span> <span class="p">-&gt;</span> <span class="s">"Off"</span>
    <span class="nc">State</span><span class="p">.</span><span class="nc">On</span> <span class="p">-&gt;</span> <span class="s">"On"</span>
<span class="p">}</span>
<span class="kd">val</span> <span class="py">decision</span> <span class="p">=</span> <span class="nf">decide</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="типы">Типы</h3>

<h4 id="любой-тип">Любой тип</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">a</span><span class="p">:</span> <span class="kt">Any</span> <span class="o">=</span> <span class="s">"Hello"</span>
<span class="k">let</span> <span class="nv">b</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="o">=</span> <span class="kt">SomeClass</span><span class="p">()</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">a</span><span class="p">:</span> <span class="nc">Any</span> <span class="p">=</span> <span class="s">"Hello"</span>
<span class="c1">// no AnyObject yet</span>
</code></pre></div></div>

<h4 id="строковая-интерполяция">Строковая интерполяция</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">str</span> <span class="o">=</span> <span class="s">"Hello </span><span class="se">\(</span><span class="n">nickname</span><span class="se">)</span><span class="s">"</span>
<span class="k">let</span> <span class="nv">str2</span> <span class="o">=</span> <span class="s">"Hello </span><span class="se">\(</span><span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="se">)</span><span class="s">"</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">str</span> <span class="p">=</span> <span class="s">"Hello $nickname"</span>
<span class="kd">val</span> <span class="py">str2</span> <span class="p">=</span> <span class="s">"Hello ${user.nickname}"</span>
</code></pre></div></div>

<h4 id="интервалы-ranges">Интервалы (Ranges)</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">rng1</span> <span class="o">=</span> <span class="mi">0</span><span class="o">...</span><span class="mi">10</span>
<span class="k">let</span> <span class="nv">rng2</span> <span class="o">=</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="mi">10</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">rng1</span> <span class="p">=</span> <span class="mi">0</span><span class="o">..</span><span class="mi">10</span>
<span class="c1">// no rng2</span>
</code></pre></div></div>

<h4 id="коллекции">Коллекции</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">stringArray</span> <span class="o">=</span> <span class="p">[</span><span class="kt">String</span><span class="p">]()</span>
<span class="c1">// no stringList</span>
<span class="k">let</span> <span class="nv">stringFloatMap</span> <span class="o">=</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Float</span><span class="p">]()</span>
<span class="k">let</span> <span class="nv">stringSet</span> <span class="o">=</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span><span class="p">()</span>

<span class="k">var</span> <span class="nv">countries</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Switzerland"</span><span class="p">,</span> <span class="s">"France"</span><span class="p">,</span> <span class="s">"Germany"</span><span class="p">]</span>
<span class="n">countries</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="s">"Italy"</span><span class="p">)</span>
<span class="n">countries</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="s">"France"</span><span class="p">)</span>

<span class="k">var</span> <span class="nv">jobs</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"Roger"</span><span class="p">:</span> <span class="s">"CEO"</span><span class="p">,</span>
    <span class="s">"Martin"</span><span class="p">:</span> <span class="s">"CTO"</span>
<span class="p">]</span>
<span class="n">jobs</span><span class="p">[</span><span class="s">"Adrian"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Writer"</span>
</code></pre></div></div>

<p>Kotlin</p>

<ul>
  <li>Нельзя использовать [] для инициализации массива, используется arrayOf</li>
  <li>в arrayOf добавлять и удалять элементы нельзя, можно только их менять</li>
</ul>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">stringArray</span> <span class="p">=</span> <span class="n">arrayOf</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;()</span>
<span class="kd">val</span> <span class="py">stringList</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;()</span>
<span class="kd">val</span> <span class="py">stringFloatMap</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Float</span><span class="p">&gt;()</span>
<span class="kd">val</span> <span class="py">stringSet</span> <span class="p">=</span> <span class="n">setOf</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;()</span>

<span class="kd">val</span> <span class="py">countries</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;(</span><span class="s">"Switzerland"</span><span class="p">,</span> <span class="s">"France"</span><span class="p">,</span> <span class="s">"Germany"</span><span class="p">)</span>
<span class="n">countries</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s">"Italy"</span><span class="p">)</span>
<span class="n">countries</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="s">"France"</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">jobs</span> <span class="p">=</span> <span class="nf">mutableMapOf</span><span class="p">(</span>
    <span class="s">"Roger"</span> <span class="n">to</span> <span class="s">"CEO"</span><span class="p">,</span>
    <span class="s">"Martin"</span> <span class="n">to</span> <span class="s">"CTO"</span>
<span class="p">)</span>
<span class="n">jobs</span><span class="p">[</span><span class="s">"Adrian"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"Writer"</span>
</code></pre></div></div>

<h4 id="итерирование-коллекций">Итерирование коллекций</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">str</span> <span class="k">in</span> <span class="n">stringArray</span> <span class="p">{}</span>
<span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span> <span class="k">in</span> <span class="n">stringArray</span><span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span> <span class="p">{}</span>
<span class="c1">// no for str in stringList</span>
<span class="k">for</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="k">in</span> <span class="n">stringFloatMap</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">str</span> <span class="k">in</span> <span class="n">stringSet</span> <span class="p">{}</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">str</span> <span class="k">in</span> <span class="n">stringArray</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">for</span> <span class="p">(</span><span class="n">str</span> <span class="k">in</span> <span class="n">stringList</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">for</span> <span class="p">((</span><span class="n">str</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="k">in</span> <span class="n">stringFloatMap</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">for</span> <span class="p">(</span><span class="n">str</span> <span class="k">in</span> <span class="n">stringSet</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></div></div>

<h3 id="процедурное-программирование">Процедурное программирование</h3>

<h4 id="процедуры-и-функции">Процедуры и функции</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">method1</span><span class="p">(</span><span class="nv">input</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">input</span><span class="o">.</span><span class="n">count</span>
<span class="p">}</span>

<span class="c1">// no method2</span>

<span class="kd">func</span> <span class="n">method3</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">input</span><span class="p">:</span> <span class="kt">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">String</span><span class="p">(</span><span class="nv">describing</span><span class="p">:</span> <span class="n">input</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">method1</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">input</span><span class="p">.</span><span class="n">length</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">method2</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="n">length</span>

<span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span><span class="nf">method3</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="nc">T</span><span class="p">)</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="nf">toString</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="ооп">ООП</h3>

<h4 id="интерфейсы">Интерфейсы</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Person</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">greet</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span>
    
    <span class="kd">func</span> <span class="nf">showMoreInformation</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Person</span> <span class="p">{</span>
	<span class="kd">func</span> <span class="nf">greet</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="s">"Hello! I am </span><span class="se">\(</span><span class="k">self</span><span class="se">)</span><span class="s">"</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">Person</span> <span class="p">{</span>
    
    <span class="kd">var</span> <span class="py">name</span><span class="p">:</span> <span class="nc">String</span>
        <span class="k">get</span> <span class="k">set</span>

    
    <span class="k">fun</span> <span class="nf">greet</span><span class="p">()</span> <span class="p">=</span> <span class="s">"Hello! I am $this"</span>

    
    <span class="k">fun</span> <span class="nf">showMoreInformation</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="конструкторы">Конструкторы</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">Manager</span><span class="p">:</span> <span class="kt">Person</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">backingName</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">var</span> <span class="nv">staff</span><span class="p">:</span> <span class="p">[</span><span class="kt">Person</span><span class="p">]</span>
    <span class="k">var</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">State</span>
    <span class="k">let</span> <span class="nv">isActive</span><span class="p">:</span> <span class="kt">Bool</span>
    <span class="nf">init</span><span class="p">(</span><span class="n">backingName</span> <span class="o">=</span> <span class="s">""</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">staff</span><span class="p">:</span> <span class="p">[</span><span class="kt">Person</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">State</span> <span class="o">=</span> <span class="o">.</span><span class="n">off</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">backingName</span> <span class="o">=</span> <span class="n">backingName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">staff</span> <span class="o">=</span> <span class="n">staff</span>
        <span class="k">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isActive</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Manager</span><span class="p">(</span><span class="k">private</span> <span class="kd">var</span> <span class="py">backingName</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
              <span class="k">private</span> <span class="kd">var</span> <span class="py">staff</span><span class="p">:</span> <span class="nc">MutableList</span><span class="p">&lt;</span><span class="nc">Person</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">Person</span><span class="p">&gt;(),</span>
              <span class="kd">var</span> <span class="py">state</span><span class="p">:</span> <span class="nc">State</span> <span class="p">=</span> <span class="nc">State</span><span class="p">.</span><span class="nc">Off</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Person</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">isActive</span><span class="p">:</span> <span class="nc">Boolean</span>
    <span class="nf">init</span> <span class="p">{</span>
        <span class="n">isActive</span> <span class="p">=</span> <span class="k">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="data-classes-ponsoposs-vs-pojo">Data Classes (PONSO/POSS vs POJO)</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Employee</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">backingName</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">age</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">backingName</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span> <span class="nv">age</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">backingName</span> <span class="o">=</span> <span class="n">backingName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">data class</span> <span class="nc">Employee</span><span class="p">(</span><span class="k">private</span> <span class="kd">var</span> <span class="py">backingName</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="s">""</span><span class="p">,</span>
                    <span class="kd">var</span> <span class="py">age</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">30</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Person</span> <span class="p">{</span>
</code></pre></div></div>

<h4 id="инстанцирование-объектов">Инстанцирование объектов</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="kt">Employee</span><span class="p">(</span>
    <span class="nv">name</span><span class="p">:</span> <span class="s">"Olivia"</span><span class="p">,</span> 
    <span class="nv">age</span><span class="p">:</span> <span class="mi">45</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">person1</span> <span class="p">=</span> <span class="nc">Employee</span><span class="p">(</span><span class="s">"Olivia"</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span> 

<span class="kd">val</span> <span class="py">person2</span> <span class="p">=</span> <span class="nc">Employee</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span> 
    <span class="n">name</span> <span class="p">=</span> <span class="s">"Thomas"</span>
    <span class="n">age</span> <span class="p">=</span> <span class="mi">56</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="расширения-классов">Расширения классов</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Double</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">fahrenheit</span><span class="p">:</span> <span class="kt">Double</span> <span class="p">{</span>
	    <span class="p">(</span><span class="k">self</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nv">celsius</span><span class="p">:</span> <span class="kt">Double</span> <span class="p">{</span>
       <span class="p">(</span><span class="k">self</span> <span class="o">-</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">9</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">temperature</span> <span class="o">=</span> <span class="kt">Double</span><span class="p">(</span><span class="mf">32.0</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">fahrenheit</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">fahrenheit</span>
<span class="k">let</span> <span class="nv">celsius</span> <span class="o">=</span> <span class="n">fahrenheit</span><span class="o">.</span><span class="n">celsius</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">temperature</span><span class="se">)</span><span class="s"> degrees Celsius is </span><span class="se">\(</span><span class="n">fahrenheit</span><span class="se">)</span><span class="s"> degrees Fahrenheit"</span><span class="p">)</span>

</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">Double</span><span class="p">.</span><span class="n">fahrenheit</span><span class="p">:</span> <span class="nc">Double</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="p">(</span><span class="k">this</span> <span class="p">*</span> <span class="mi">9</span> <span class="p">/</span> <span class="mi">5</span><span class="p">)</span> <span class="p">+</span> <span class="mi">32</span>
<span class="kd">val</span> <span class="py">Double</span><span class="p">.</span><span class="n">celsius</span><span class="p">:</span> <span class="nc">Double</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="p">(</span><span class="k">this</span> <span class="p">-</span> <span class="mi">32</span><span class="p">)</span> <span class="p">*</span> <span class="mi">5</span> <span class="p">/</span> <span class="mi">9</span>

<span class="kd">val</span> <span class="py">temperature</span><span class="p">:</span> <span class="nc">Double</span> <span class="p">=</span> <span class="mf">32.0</span>
<span class="kd">val</span> <span class="py">fahrenheit</span> <span class="p">=</span> <span class="n">temperature</span><span class="p">.</span><span class="n">fahrenheit</span>
<span class="kd">val</span> <span class="py">celsius</span> <span class="p">=</span> <span class="n">fahrenheit</span><span class="p">.</span><span class="n">celsius</span>
<span class="nf">println</span><span class="p">(</span><span class="s">"$temperature degrees Celsius is $fahrenheit degrees Fahrenheit"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="простые-объекты-и-singletonы">Простые объекты и Singleton’ы</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">Constants</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">PI</span> <span class="o">=</span> <span class="mf">3.14</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">ANSWER</span> <span class="o">=</span> <span class="mi">42</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">name</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">"Math constants"</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">object</span> <span class="nc">Constants</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">PI</span> <span class="p">=</span> <span class="mf">3.14</span>
    <span class="kd">val</span> <span class="py">ANSWER</span> <span class="p">=</span> <span class="mi">42</span>

    <span class="k">fun</span> <span class="nf">name</span><span class="p">()</span> <span class="p">=</span> <span class="s">"Math contstants"</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="объекты-компаньоны">Объекты-компаньоны</h4>

<p>Swift</p>

<ul>
  <li>Просто используйте static (class) члены</li>
</ul>

<p>Kotlin</p>

<ul>
  <li>В Kotlin нет статических членов</li>
</ul>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">companion</span> <span class="k">object</span> <span class="nc">OptionalName</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">MAXIMUM_EMPLOYEE_COUNT</span> <span class="p">=</span> <span class="mi">10</span>

    <span class="k">fun</span> <span class="nf">managerFactory</span><span class="p">()</span> <span class="p">=</span> <span class="nc">Manager</span><span class="p">(</span><span class="s">"Maria Hill"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="перегрузка-операторов">Перегрузка операторов</h4>

<p>Swift</p>

<ul>
  <li>Можно делать свои операторы (например квадратный корень)</li>
</ul>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="o">+</span> <span class="p">(</span><span class="nv">lhs</span><span class="p">:</span> <span class="kt">Person</span><span class="p">,</span> <span class="nv">rhs</span><span class="p">:</span> <span class="kt">Person</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Team</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">Team</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">team</span> <span class="o">=</span> <span class="n">manager</span> <span class="o">+</span> <span class="n">person</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">operator</span> <span class="k">fun</span> <span class="nf">plus</span><span class="p">(</span><span class="n">person</span><span class="p">:</span> <span class="nc">Person</span><span class="p">):</span> <span class="nc">Team</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nc">Team</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">person</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">val</span> <span class="py">team</span> <span class="p">=</span> <span class="n">manager</span> <span class="p">+</span> <span class="n">person</span>
</code></pre></div></div>

<h4 id="инфиксные-методы">Инфиксные методы</h4>

<p>Swift</p>

<ul>
  <li>Не применимо</li>
</ul>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">infix</span> <span class="k">fun</span> <span class="nf">addPerson</span><span class="p">(</span><span class="n">person</span><span class="p">:</span> <span class="nc">Person</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">staff</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="p">&lt;</span> <span class="nc">MAXIMUM_EMPLOYEE_COUNT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">staff</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nc">Exception</span><span class="p">(</span><span class="s">"Cannot add more staff members"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">manager</span> <span class="n">addPerson</span> <span class="n">person</span>
</code></pre></div></div>

<h4 id="перечисления">Перечисления</h4>

<p>Swift</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">State</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">on</span>
    <span class="k">case</span> <span class="n">off</span>
    
    <span class="k">var</span> <span class="nv">desc</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">notify</span><span class="p">()</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="kd">class</span> <span class="nc">State</span> <span class="p">{</span>
    <span class="nc">On</span><span class="p">,</span> <span class="nc">Off</span>
    
    <span class="kd">var</span> <span class="py">desc</span><span class="p">:</span> <span class="nc">String</span> <span class="p">{</span> <span class="o">..</span><span class="p">.</span> <span class="p">}</span>
    <span class="n">func</span> <span class="nf">notify</span><span class="p">()</span> <span class="p">=</span> <span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="резюмирующая-табличка">Резюмирующая табличка</h3>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>Kotlin 1.2</th>
      <th>Objective-C 2.0</th>
      <th>Swift 4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Наследование</td>
      <td>Одинарное, с интерфейсами и расширениями</td>
      <td>Одинарное, с протоколами</td>
      <td>Одинарное, с протоколами и расширениями</td>
    </tr>
    <tr>
      <td>Точки с запятой <code class="language-plaintext highlighter-rouge">;</code></td>
      <td>Не обязательны</td>
      <td>Обязательны</td>
      <td>Не обязательны</td>
    </tr>
    <tr>
      <td>Объявление класса</td>
      <td><code class="language-plaintext highlighter-rouge">class</code></td>
      <td><code class="language-plaintext highlighter-rouge">@interface &amp; @implementation</code></td>
      <td><code class="language-plaintext highlighter-rouge">class</code></td>
    </tr>
    <tr>
      <td>Интерфейсы</td>
      <td>реализует <code class="language-plaintext highlighter-rouge">interface</code></td>
      <td>поддерживает <code class="language-plaintext highlighter-rouge">@protocol</code></td>
      <td>поддерживает <code class="language-plaintext highlighter-rouge">protocol</code></td>
    </tr>
    <tr>
      <td>Подключение кода</td>
      <td><code class="language-plaintext highlighter-rouge">import (символы)</code></td>
      <td><code class="language-plaintext highlighter-rouge">#import (файлы)</code></td>
      <td><code class="language-plaintext highlighter-rouge">import (символы)</code></td>
    </tr>
    <tr>
      <td>Расширение классов</td>
      <td>Расширения</td>
      <td>Категории</td>
      <td>Расширения</td>
    </tr>
    <tr>
      <td>Динамическая типизация</td>
      <td><code class="language-plaintext highlighter-rouge">Any</code></td>
      <td><code class="language-plaintext highlighter-rouge">id</code></td>
      <td><code class="language-plaintext highlighter-rouge">Any</code></td>
    </tr>
    <tr>
      <td>Суффикс приватных полей</td>
      <td>Не используется</td>
      <td><code class="language-plaintext highlighter-rouge">_</code> (подчеркивание)</td>
      <td><code class="language-plaintext highlighter-rouge">_</code> (подчеркивание)</td>
    </tr>
    <tr>
      <td>Управление памятью</td>
      <td>Сборка мусора (GС)</td>
      <td>Ручное или автоматическое управление памятью (MRC vs ARC)</td>
      <td>Автоматическое управление памятью (ARC)</td>
    </tr>
    <tr>
      <td>Дженерики</td>
      <td>да (type erasure)</td>
      <td>да (type erasure)</td>
      <td>да</td>
    </tr>
    <tr>
      <td>Указатели на метод</td>
      <td>нет</td>
      <td><code class="language-plaintext highlighter-rouge">@selector</code></td>
      <td><code class="language-plaintext highlighter-rouge">#selector</code></td>
    </tr>
    <tr>
      <td>Обратный вызов (callbacks)</td>
      <td>Лямбды</td>
      <td>Делегаты и блоки</td>
      <td>замыкания</td>
    </tr>
    <tr>
      <td>Указатели</td>
      <td>нет</td>
      <td>да</td>
      <td>Через библиотечные классы</td>
    </tr>
    <tr>
      <td>Корневые классы</td>
      <td><code class="language-plaintext highlighter-rouge">Object</code></td>
      <td><code class="language-plaintext highlighter-rouge">NSObject</code> / <code class="language-plaintext highlighter-rouge">NSProxy</code> / …</td>
      <td><code class="language-plaintext highlighter-rouge">NSObject</code> / <code class="language-plaintext highlighter-rouge">NSProxy</code> / …</td>
    </tr>
    <tr>
      <td>Управление областью видимости</td>
      <td><code class="language-plaintext highlighter-rouge">public</code> / <code class="language-plaintext highlighter-rouge">internal</code> / <code class="language-plaintext highlighter-rouge">protected</code> / <code class="language-plaintext highlighter-rouge">private</code></td>
      <td><code class="language-plaintext highlighter-rouge">@public</code> / <code class="language-plaintext highlighter-rouge">@protected</code> / <code class="language-plaintext highlighter-rouge">@private</code> (только поля)</td>
      <td><code class="language-plaintext highlighter-rouge">open</code> / <code class="language-plaintext highlighter-rouge">public</code> / <code class="language-plaintext highlighter-rouge">internal</code> / <code class="language-plaintext highlighter-rouge">fileprivate</code> / <code class="language-plaintext highlighter-rouge">private</code></td>
    </tr>
    <tr>
      <td>Обработка ошибок</td>
      <td><code class="language-plaintext highlighter-rouge">try</code> / <code class="language-plaintext highlighter-rouge">catch</code> / <code class="language-plaintext highlighter-rouge">finally</code> + <code class="language-plaintext highlighter-rouge">Exception</code></td>
      <td><code class="language-plaintext highlighter-rouge">@try</code> / <code class="language-plaintext highlighter-rouge">@catch</code> / <code class="language-plaintext highlighter-rouge">@finally</code> + <code class="language-plaintext highlighter-rouge">NSException</code></td>
      <td><code class="language-plaintext highlighter-rouge">do</code> / <code class="language-plaintext highlighter-rouge">try</code> / <code class="language-plaintext highlighter-rouge">catch</code> + <code class="language-plaintext highlighter-rouge">Error</code></td>
    </tr>
    <tr>
      <td>Пространства имен</td>
      <td>Пакеты</td>
      <td>Через префиксы классов</td>
      <td>Неявные, через модули</td>
    </tr>
    <tr>
      <td>Грамматика</td>
      <td>kotlinlang.org</td>
      <td> </td>
      <td>developer.apple.com</td>
    </tr>
  </tbody>
</table>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/01/06/vscode-cpp-docker-debugging/">
        Разрабатываем и отлаживаем С++ в Docker с помощью VSCode
      </a>
    </h1>

    <i class="icon fa fa-calendar-o text-danger"></i><span class="post-date">06.01.2018</span>
	<i class="icon fa fa-tags text-success"></i><p class="entry-tags">
  	
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#c%2B%2B" title="Pages tagged c++" rel="tag" class="text-success">c++</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#linux" title="Pages tagged linux" rel="tag" class="text-success">linux</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#ubuntu" title="Pages tagged ubuntu" rel="tag" class="text-success">ubuntu</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#gcc" title="Pages tagged gcc" rel="tag" class="text-success">gcc</a>
        </div>
        &nbsp;
      
  	  <div class="label bg-success">
  	    <a href="http://mrdekk.ru/tags/#vscode" title="Pages tagged vscode" rel="tag" class="text-success">vscode</a>
        </div>
        
      
    </p>

    <p>Продолжаем цикл статей “Как кодить на С++ под OSX для Ubuntu”. После сборки cross-toolchain’ов стояла задача научиться собирать, запускать и отлаживать С++ под OSX для Linux (Ubuntu в данном случае). Как оказалось cross-toolchain был не нужен :(. Но об этом позже.</p>

<p>Для начала нужна была IDE, в которой можно было бы комфортно редактировать код и отлаживаться. Претенденты были такие: Xcode, Eclipse (CDT), CLion, чуть позже к ним добавился VSCode и впоследствии выиграл соревнование.</p>

<p>Постановка задачи была такая: C++, CMake, Linux, при этом редактирование кода и отладка должна работать под OSX.</p>

<p>Xcode поэтому выпал из этой гонки сразу, он есть очень удобная IDE для C++, но в целом в основном для OSX. CMake наверное завести можно, но это будет большое количество сторонних средств.</p>

<p>CLion выпал из этой же гонки примерно по тем же причинам (хотя он вроде умеет в CMake). Плюс я не смог в нем нормально подружиться с Docker.</p>

<p>Остался Eclipse CDT, в нем получилось практически все что требовалось (с cross-toolchain), завелась даже отладка через cross-gdb, однако были странные махинации чтобы нормально работать с CMake и контейнером он управлял относительно сам (не совсем прозрачно), хотя надо отметить что поддержка Docker в Eclipse плюс-минус хорошая.</p>

<p>После этого я пошел посерфить интеренет в поисках каких-нибудь идей, как нормально подружить Eclipse и CMake, и тут я наткнулся на VSCode. Которые не позиционирует себя как IDE, но умеет в дебаг и всякие user-defined task’и. Несмотря на мое некоторое отношение к продуктам Microsoft, я решил дать этому редактору шанс и попробовал его… и надо признать, это очень хороший инструмент.</p>

<p>Теперь же собственно, как завести, чтобы все работало.</p>

<p>Для начала нам понадобится собственно VSCode, настроенный так, как вам наиболее удобно. Можно сразу поставить расширения для работы с C++ (C/C++, Native Debug), CMake (CMake, CMake Tools), Docker.</p>

<p>Далее нам потребуется такая структура проекта (в принципе вы можете выбрать такую структуру, какая вам больше нравится, это скажем так рабочий пример):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.vscode
  tasks.json
  launch.json
build
CMakeLists.txt
dbuild.sh
ddebugger.sh
dmaker.sh
Dockerfile
main.cpp
</code></pre></div></div>

<p>Начнем с С++, пример простой, однако чтобы понять что мы действительно работаем для Linux я добавил несколько linux’овых вещей.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="n">HOST_NAME_MAX</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">username</span><span class="p">[</span><span class="n">LOGIN_NAME_MAX</span><span class="p">];</span>
	<span class="n">gethostname</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">HOST_NAME_MAX</span><span class="p">);</span>
	<span class="n">getlogin_r</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">LOGIN_NAME_MAX</span><span class="p">);</span>

	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"hostname: "</span> <span class="o">&lt;&lt;</span> <span class="n">hostname</span> <span class="o">&lt;&lt;</span> <span class="s">", login: "</span> <span class="o">&lt;&lt;</span> <span class="n">username</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="c1">// prints Hello World!</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Этот код мы будем собирать, запускать и отлаживать.</p>

<p>Далее CMakeLists.txt, который тоже простой и относительно шаблонный:</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.5<span class="p">)</span>

<span class="nb">project</span><span class="p">(</span>HWord<span class="p">)</span>

<span class="nb">set</span><span class="p">(</span>HWORD_VERSION_MAJOR 1<span class="p">)</span>
<span class="nb">set</span><span class="p">(</span>HWORD_VERSION_MINOR 0<span class="p">)</span>

<span class="nb">set</span><span class="p">(</span>SOURCE <span class="si">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="si">}</span>/main.cpp<span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span><span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span> <span class="si">${</span><span class="nv">SOURCE</span><span class="si">}</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="собираем">Собираем</h2>

<p>Как я уже выше писал сначала я пытался собрать все это безобразие под OSX с помощью cross-toolchain. Это плюс-минус работало, но часто приходилось пересобирать toolchain с еще каким-нибудь волшебным флагом, а на моем машине это делается примерно 3 часа. В одну из таких пересборок мне пришла мысль, а почему бы не собирать docker’ом, т.е. gcc который в контейнере и в требуемой системе (linux).</p>

<p>Таким образом собираем такой контейнер:</p>

<p>Dockerfile</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM ubuntu:16.04

RUN apt-get update 
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y gcc g++ gdb cmake

WORKDIR /opt/build
VOLUME ["/opt"]
</code></pre></div></div>

<p>Для упрощения работы с командной строкой docker’а заведем пару скриптов:</p>

<p><strong>Скрипт сборки образа:</strong></p>

<p>dbuild.sh</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">cwd</span><span class="o">=</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>

docker build <span class="se">\</span>
    <span class="nt">-t</span> mrdekk/maker <span class="se">\</span>
    <span class="nb">.</span>
</code></pre></div></div>

<p>Ничего сверхординарного, но возможно вам лучше поставить свой тег, вместо <code class="language-plaintext highlighter-rouge">mrdekk/maker</code> сделать <code class="language-plaintext highlighter-rouge">%username%/maker</code></p>

<p><strong>Скрипт запуска сборок:</strong></p>

<p>dmaker.sh</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">cwd</span><span class="o">=</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>

docker stop maker
docker <span class="nb">rm </span>maker
docker run <span class="se">\</span>
	<span class="nt">-it</span> <span class="se">\</span>
	<span class="nt">--name</span> maker <span class="se">\</span>
	<span class="nt">-p</span> 6666:6666 <span class="se">\</span>
	<span class="nt">-v</span> <span class="k">${</span><span class="nv">cwd</span><span class="k">}</span>:/opt <span class="se">\</span>
	<span class="nt">--privileged</span> <span class="se">\</span>
	mrdekk/maker <span class="se">\</span>
    <span class="s2">"</span><span class="k">${</span><span class="p">@</span><span class="k">}</span><span class="s2">"</span> 
</code></pre></div></div>

<p><strong>Скрипт запуска контейнера для отладки:</strong></p>

<p>ddebugger.sh</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">cwd</span><span class="o">=</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>

docker stop maker
docker <span class="nb">rm </span>maker
docker run <span class="se">\</span>
	<span class="nt">-dt</span> <span class="se">\</span>
	<span class="nt">--name</span> maker <span class="se">\</span>
	<span class="nt">-p</span> 6666:6666 <span class="se">\</span>
	<span class="nt">-v</span> <span class="k">${</span><span class="nv">cwd</span><span class="k">}</span>:/opt <span class="se">\</span>
	<span class="nt">--privileged</span> <span class="se">\</span>
	mrdekk/maker <span class="se">\</span>
    <span class="s2">"</span><span class="k">${</span><span class="p">@</span><span class="k">}</span><span class="s2">"</span> 
</code></pre></div></div>

<p>Скрипты запуска сборки и дебаггера в общем отличаются только ключами -it и -dt.</p>

<p>Теперь сделаем несколько задач (tasks) для VSCode</p>

<p><strong>Задача сборки контейнера:</strong></p>

<p>Ничего особенного, вызываем скрипт dbuild.sh</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Docker: Build Containers"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/dbuild.sh"</span><span class="p">,</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p>И заодно выполняем ее, после этого можете сделать <code class="language-plaintext highlighter-rouge">docker images</code> и проверить, что образ mrdekk/maker появился</p>

<p><strong>Задача для CMake:</strong></p>

<p>Теперь с помощью CMake сгенерим Makefile’ы для сборки проекта. Здесь мы воспользуемся скриптом dmaker.sh, но будем вызывать его с набором ключей:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CMake: Initialize"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/dmaker.sh"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"cmake"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-G"</span><span class="p">,</span><span class="w"> </span><span class="s2">"'Unix Makefiles'"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-DCMAKE_BUILD_TYPE=Debug"</span><span class="p">,</span><span class="w"> </span><span class="s2">"/opt"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">/opt</code> это путь до Volume’а в контейнере в который мы будем проецировать текущую папку с исходниками проекта - это в общем часть магии.</p>

<p>После этого в подпапке build вы должны увидеть сгенерированные cmake’ом файлы.</p>

<p><strong>Задача для сборки бинарника:</strong></p>

<p>Здесь снова используем скрипт dmaker.sh но с другими ключами</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Make: Build Project"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/dmaker.sh"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"make"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-j"</span><span class="p">,</span><span class="w"> </span><span class="s2">"8"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"group"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"build"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isDefault"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p>После того, как собереться можете попробовать сделать так <code class="language-plaintext highlighter-rouge">./build/HWord</code> на OSX, и вы должны получить примерно такое:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exec format error: ./build/HWord
</code></pre></div></div>

<p>Это правильно, наш бинарник собран для linux и на OSX запускаться не должен. Если же вы увидите вывод программы, это значит что что-то пошло не так (вы собрали OSX’овым компилятором).</p>

<h2 id="запускаем-без-отладки">Запускаем без отладки</h2>

<p>Теперь у нас есть бинарник, надо проверить что он запускается. Для этого снова воспользуемся скриптом dmaker.sh и такой задачей:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Docker: Run Containers"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/dmaker.sh"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"/opt/build/HWord"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p>После этого вы должны увидеть в <code class="language-plaintext highlighter-rouge">docker logs maker</code> и терминале VSCode примерно такое</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hostname: 03a3a4dee13f, login:
</code></pre></div></div>

<p>Это хорошо, наш бинарник на linux работает хорошо.</p>

<h2 id="отлаживаемся">Отлаживаемся</h2>

<p>С помощью VSCode поставьте breakpoint куда-нибудь в коде. Нам будет необходим запущенный в фоне контейнер, внутри которого мы через <code class="language-plaintext highlighter-rouge">docker exec</code> будем запускать gdb. Увы, завести VSCode так, чтобы он смог нормально в интерактивном режиме (dmaker.sh и -it) запускать debugger у меня не получилось (видимо механизм запуска дебаггера в VSCode как-то так хитро устроен), поэтому я воспользовался pipeTransport и все заработало.</p>

<p>Таким образом задача для предварительного запуска контейнера:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Docker: Run Debugging Container"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/ddebugger.sh"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"bash"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>а launch.json выглядит так</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.2.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Container Debug"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cppdbg"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"launch"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"program"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/opt/build/HWord"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/opt"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"linux"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"MIMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gdb"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"setupCommands"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Enable pretty-printing for gdb"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-enable-pretty-printing"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"ignoreFailures"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"osx"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"MIMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gdb"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"setupCommands"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Enable pretty-printing for gdb"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-enable-pretty-printing"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"ignoreFailures"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="err">//</span><span class="w"> </span><span class="nl">"preLaunchTask"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Docker: Run Debugging Container"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"pipeTransport"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"pipeProgram"</span><span class="p">:</span><span class="w"> </span><span class="s2">"docker"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"pipeCwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceRoot}"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"pipeArgs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"exec"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-i"</span><span class="p">,</span><span class="w"> </span><span class="s2">"maker"</span><span class="p">,</span><span class="w"> </span><span class="s2">"sh"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-c"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"quoteArgs"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
                </span><span class="nl">"debuggerPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/bin/gdb"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"sourceFileMap"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"/opt"</span><span class="p">:</span><span class="s2">"${workspaceFolder}"</span><span class="w">
            </span><span class="p">},</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Внимательно ко всем параметрам, они все имеют значение.</p>

<p>После этого жмем F5 (или в меню выбираем Start Debugging) и… отлаживаемся. Дебаггер должен остановить выполнение в установленном вами breakpoint’е.</p>

<p>Примеры кода и исходники к статье лежат тут <a href="https://github.com/mrdekk/viscose-cpp-docker">mrdekk/viscose-cpp-docker</a>.</p>

<p>P.S. Да, я тоже ненавижу автокомплит, когда он что-то исправляет. В названии репозитория должно было быть vscode-cpp-docker, а получилось viscose-cpp-docker. Но, ладно! Так тому и быть.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2"><i class="fa fa-hand-o-left" ></i> назад</a>
  
  
    <span class="pagination-item newer">вперед <i class="fa fa-hand-o-right" ></i></span>
  
</div>

    </div>

	<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter13259782 = new Ya.Metrika({
                    id:13259782,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true,
                    webvisor:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/13259782" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-16734363-2', 'auto');
  ga('send', 'pageview');

</script>

    <script src="/public/js/tabs.js"></script>

  </body>
</html>
